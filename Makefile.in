##########################################################################
#                                                                        #
#  This software is free software; you can redistribute it and/or        #
#  modify it under the terms of the GNU Library General Public           #
#  License version 2.1, with the special exception on linking            #
#  described in file LICENSE.                                            #
#                                                                        #
#  This software is distributed in the hope that it will be useful,      #
#  but WITHOUT ANY WARRANTY; without even the implied warranty of        #
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                  #
#                                                                        #
##########################################################################


# OCaml tools
OCAMLC    = @OCAMLC@
OCAMLOPT  = @OCAMLOPT@
OCAMLDEP  = @OCAMLDEP@ -slash
OCAMLDOC  = @OCAMLDOC@
OCAMLLEX  = @OCAMLLEX@
OCAMLYACC = @OCAMLYACC@ -v
OCAMLFIND = @OCAMLFIND@

# Libraries
Z3ML = @Z3ML@
OCAMLGRAPH = @OCAMLGRAPH@

INCLUDES = -I $(Z3ML) -I $(OCAMLGRAPH)
BFLAGS = $(INCLUDES) -g -w -8 -annot
OFLAGS = $(INCLUDES) -w -8 -annot

# main target
#############

NAME = yhorn
all: byte opt

# bytecode and native-code compilation
######################################

CMO = version error id util mapEx puf combine types parser lexer z3interface \
      constr unify hornSolve template hornGet interpolation horn
CMO :=  $(patsubst %, %.cmo, $(CMO))

CMX = $(CMO:.cmo=.cmx)
CMA = $(NAME).cma
CMXA = $(NAME).cmxa

GENERATED = META version.ml parser.ml parser.mli lexer.ml

$(CMX): OFLAGS += -for-pack Yhorn

byte: $(CMA)
opt: $(CMXA)

$(NAME).cma: $(NAME).cmo
	$(OCAMLC) $(INCLUDES) -a -g -o $@ $^

$(NAME).cmxa: $(NAME).cmx
	$(OCAMLOPT) $(INCLUDES) -a -o $@ $^

$(NAME).cmo: $(CMI) $(CMO)
	$(OCAMLC) $(INCLUDES) -pack -g -o $@ $^

$(NAME).cmx: $(CMI) $(CMX)
	$(OCAMLOPT) $(INCLUDES) -pack -o $@ $^

$(NAME).byte: $(CMI) $(CMO) interactive.cmo
	$(OCAMLC) $(INCLUDES) -g -o $@ \
		unix.cma z3.cma graph.cma $^

$(NAME).opt: $(CMI) $(CMX) interactive.cmx
	$(OCAMLOPT) $(INCLUDES) -unsafe -inline 100 -o $@ \
		unix.cmxa z3.cmxa graph.cmxa $^

VERSION = 0.3

version.ml: Makefile
	rm -f $@
	echo "let version = \""$(VERSION)"\"" > $@
	echo "let date = \""`date`"\"" >> $@

META: META.in Makefile
	sed -e s/VERSION/$(VERSION)/ -e s/CMA/$(CMA)/ -e s/CMXA/$(CMXA)/ \
		$@.in > $@

# documentation
###############

DOCFILES = $(NAME).ps $(NAME).html
DOCDIR   = doc

NODOC	 = parser lexer version
NODOC	:= $(patsubst %, $(SRCDIR)/%.cmo, $(NODOC))
DOC_CMO	 = $(filter-out $(NODOC), $(CMO))
DOC_SRC	 = $(DOC_CMO:.cmo=.ml) $(wildcard *.mli)

.PHONY: doc depgraph

doc: $(DOCDIR)/index.html
depgraph: $(DOCDIR)/$(NAME).ps
	gv $(DOCDIR)/$(NAME).ps

$(DOCDIR)/index.html: $(DOC_CMO)
	mkdir -p $(DOCDIR)
	rm -f $(DOCDIR)/*.html
	$(OCAMLDOC) $(INCLUDES) -d $(DOCDIR) -html $(DOC_SRC)

$(DOCDIR)/$(NAME).ps: $(DOCDIR)/$(NAME).dot
	dot -Tps $(DOCDIR)/$(NAME).dot > $(DOCDIR)/$(NAME).ps

$(DOCDIR)/$(NAME).dot: $(DOC_CMO)
	mkdir -p $(DOCDIR)
	rm -f $(DOCDIR)/*.dot
	$(OCAMLDOC) $(INCLUDES) -o doc/$(NAME).dot -dot $(DOC_SRC)

# generic rules
###############

.SUFFIXES: .mli .ml .cmi .cmo .cmx .mll .mly

.mli.cmi:
	$(OCAMLC) -c $(BFLAGS) $<

.ml.cmo:
	$(OCAMLC) -c $(BFLAGS) $<

.ml.o:
	$(OCAMLOPT) -c $(OFLAGS) $<

.ml.cmx:
	$(OCAMLOPT) -c $(OFLAGS) $<

.mll.ml:
	$(OCAMLLEX) $<

.mly.ml:
	$(OCAMLYACC) -v $<

.mly.mli:
	$(OCAMLYACC) -v $<

# Makefile is rebuilt whenever Makefile.in or configure.in is modified
######################################################################

Makefile: Makefile.in config.status
	if test -e $@; then chmod a+w $@; fi
	./config.status
	chmod a-w $@

config.status: configure
	./config.status --recheck

configure: configure.in
	autoconf

# clean
#######

clean:
	rm -f *~
	rm -f *.cm[iox] *.annot *.o
	rm -f $(GENERATED)
	rm -f $(NAME).*a $(NAME).cm* $(NAME).o $(NAME).byte $(NAME).opt

dist-clean distclean: clean
	rm -f Makefile config.cache config.log config.status *.byte *.opt

git-clean gitclean:
	rm .gitignore
	git clean -df
	git checkout .gitignore

# depend
########

.PHONY: depend
.depend depend: $(GENERATED)
	rm -f .depend
	$(OCAMLDEP) $(INCLUDES) *.ml *.mli > .depend

include .depend
