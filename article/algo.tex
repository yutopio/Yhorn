\documentclass[a4paper,12pt]{article}

\usepackage{amsmath}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{listings}
\usepackage{stmaryrd}
\usepackage{syntax}

\newcommand{\sembrack}[1]{[\![#1]\!}
\newcommand{\edge}[2]{#1\rightarrow#2}
\newcommand{\path}[2]{#1\rightarrow^\star#2}

\title{Algorithm explanation}
\author{Yuto Takei \\ The University of Tokyo}

\begin{document}
\maketitle

\section{Algorithm}

The Horn clause solving algorithm receives an input problem in Horn
graph. A Horn graph is a labelled directed graph $G=(V,E,\varphi)$,
where V is a set of vertices and E is a set of labelled
edges. $\varphi: V \rightarrow L$ is a labelling function for
vertices, where L is a set of elements of a predicate variable $P(x_1,
..., x_n)$ or a linear inequality $a_1 x_1 + \cdots + a_n x_n \leq b$.
An edge from a vertex $u$ to $v$ is expressed as a 3-tuple
$(u,v,\theta)$ where $\theta$ is a finite map from variables to
variables.

The meaning $\llbracket G \rrbracket $ of a Horn graph $G$ is a set of
Horn clauses $\mathcal{HC}_v$ for all vertices $v \in V$.

\begin{align*}
\mathcal{HC}_v & = \left( \bigwedge_{(u,v,\theta) \in E} \theta \varphi(u) \right) \Longrightarrow \varphi(v) \\
\llbracket G \rrbracket & = \bigwedge_{v \in V} \mathcal{HC}_v
\end{align*}

The solution of $G$ is a map $\rho$ from predicate variables to linear
predicates of the form $\lambda x_1, \cdots ,x_n. \psi $ (where $\psi$
is a formula constructed from
\begin{align*}
\psi ::= & a_1 x_1 + \cdots + a_n x_n \leq b \mid \\
& \psi \wedge \psi \mid \psi \vee \psi \mid true \mid false
\end{align*}
), where $\rho[G]$ is a tautology. A solution is \textit{simple} if
$\rho[P]$ is of the form $a_1 x_1 + \cdots + a_n x_n \leq b$ for every
$P$ in $dom(\rho)$.

The problem of solving Horn clauses (represented by $G$) is to find a
solution of $G$ (and a simple solution if possible).

We consider below a Horn graph that is acyclic.

Given an acyclic Horn graph (or called a Horn DAG), we define the
relation $u <^+ v$ as follows.
\[ u <^+ v \Longleftrightarrow \exists \theta. (u,v,\theta) \in E \]
By the assumption that $G$ is acyclic, $<^+$ is a well-founded
relation. We assume without loss of generality that $V$ contains the
least element $v_\bot$ with respect to $<^+$; otherwise we can always
ignore $v_\bot$ with $\varphi(v_\bot) = 0 \leq -1$.

For each $v \in V$, we define $\Delta(v) = (a_v x \leq b_v, C_v)$,
where
\begin{itemize}
\item $a_v x \leq b_v$ is a linear inequality that may contain
  coefficient variables
\item $C_v$ is a set of linear expressions on coefficient variables.
\end{itemize}
Intuitively, the pair $(\mathbf{a} \mathbf{x} \leq b, C)$ denotes the
set of inequalities:

\begin{align*}
\left\lbrace
 \mathbf{a} \mathbf{x} \leq b \middle|
 \exists \left( FV(C)
  \setminus (\mathbf{a} \cup \left\lbrace b \right\rbrace
 \right). C
\right\rbrace
\end{align*}

$\Delta(v)$ is defined by well-founded induction on $v$ with respect
to the relation $<^+$. Then,
$\Delta(v) = \left( \mathbf{a}_v \mathbf{x} \leq b_v, C_v \right)$,
where

\begin{align*}
C_v =
\bigcup_{(u,v) \in E} C_u & \cup
\left\lbrace
 \mathbf{a}_v = \sum_{(u,v) \in E} \mathbf{a}_u,
 b_v \geq \sum_{(u,v) \in E} b_u
\right\rbrace \cup
\\
& \begin{cases}
\emptyset
& \mbox{if } \varphi(v) = P(\mathbf{x}) \\
\left\lbrace
 \lambda_v \geq 0, \mathbf{a}_v = \lambda_v \mathbf{a}_0,
 b_v = \lambda_v b_0
\right\rbrace
& \mbox{if } \varphi(v) = \mathbf{a}_0 \mathbf{x} \leq b_0
\end{cases}
\end{align*}

Given $\varphi(v_\bot) = \mathbf{a}_0 \mathbf{x} \leq b_0$, any
solution $\sigma$ to the constraint $C_\star = C_{v_\bot} \cup {
  \mathbf{a}_0 = \mathbf{a}_{v_\bot} } \cup { b_0 = b_{v_\bot} }$
gives a simple solution for $G$ if $C_\star$ is satisfiable, i.e., we
should have:

\begin{quote}
If $\models \sigma(C_\star)$, then $\rho$ defined by
\begin{align*}
 \rho = \left\lbrace
  \left( P, \sigma(\mathbf{a}_v \mathbf{x} \leq b_v) \right) \middle|
  \forall v \in V. \varphi(v) = P(\mathbf{x})
 \right\rbrace
\end{align*}
is a solution of $G$.
\end{quote}

If $C_\star$ is unsatisfiable, there are two possibility for them.

\begin{itemize}
\item No solution exists for $G$.
\item No simple solution exists for $G$.
\end{itemize}

If $G$ has a vertex which has multiple successors, the second case is
possible. We now consider to give a solution to the such case.

Let $\hat u$ be a vertex with multiple successors denoted by
$succ(u)$. We now duplicate to relax the linear constraints.





The $\textsc{Copy}$ duplicates a given linear constraint by renaming
all variables to fresh ones. $\mathbf{a'}$ and $b'$ are renamed
variables from $\mathbf{a}$ and $b$ respectively.

Obtaining $G'$ after the transformation above, if $C_{v_\bot}$ becomes
satisfiable, a solution $\rho$ to $G$ is given by using solution
$\rho'$ to $G'$:

\begin{align*}
 \rho = \rho' \cup \left\lbrace P = \bigwedge_i \rho'[P_i] \middle|
 \varphi(\hat u) = P(\mathbf{x}) \right\rbrace
\end{align*}

$\forall u \in V. \path{u}{v} \wedge \varphi(u) = P(\mathbf{x}).
$

Note that predicate variables on  than $\hat u$ may
also have duplicated assignments, which should be combined in the
same manner as $P$ above.

If $C_{v_\bot}$ stays unsatisfiable in $G'$, we can repeat the
transformation until no vertices have multiple successors.

\end{document}
